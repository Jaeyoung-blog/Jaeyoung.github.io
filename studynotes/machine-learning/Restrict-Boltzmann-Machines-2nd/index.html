<!DOCTYPE html>
<html lang="ko">

<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    
      <link rel="icon" href="/favicon.png">
    

    <title>
        
          Restrict Boltzmann Machines 2 - Jaeyoung&#39;s Blog
        
    </title>

    <!-- Spectre.css framework -->
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">

    <!-- theme css & js -->
    <link rel="stylesheet" href="/css/book.css">
    <script src="/js/book.js"></script>

    <!-- tocbot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    
    <!-- katex -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">

    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/zooming/2.1.1/zooming.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const zooming = new Zooming()
    zooming.listen('.book-content img')
})
</script>

</head>

<body>

<div class="book-container">
  <div class="book-sidebar">
    <div class="book-brand">
  <a href="/">
    <img src="/favicon.png">
    <span>JAEYOUNG&#39;S BLOG</span>
  </a>
</div>
    <div class="book-menu">
  <h1 id="Home"><strong>Home</strong></h1>
<ul>
<li><a href="/">Home</a></li>
<li><a href="/Blog-Init">블로그 개장</a></li>
</ul>
<h1 id="Study-Notes"><strong>Study Notes</strong></h1>
<h2 id="Machine-Learning">Machine Learning</h2>
<ul>
<li><a href="/studynotes/machine-learning/Machine-Learning">Machine Learning</a></li>
<li><a href="/studynotes/machine-learning/KL-Divergence">KL Divergence</a></li>
<li><a href="/studynotes/machine-learning/Principal-Component-Analysis">Principal Component Analysis</a></li>
<li><a href="/studynotes/machine-learning/Restrict-Boltzmann-Machines-1st">Restrict Boltzmann Machine 1</a></li>
<li><a href="/studynotes/machine-learning/Restrict-Boltzmann-Machines-2nd">Restrict Boltzmann Machine 2</a></li>
<li><a href="/studynotes/machine-learning/Lagrangian-Multiplier">Lagrangian Multiplier</a></li>
<li><a href="/studynotes/machine-learning/Hidden-Markov-Models-1">Hidden Markov Models 1</a></li>
<li><a href="/studynotes/machine-learning/Hidden-Markov-Models-2">Hidden Markov Models 2</a></li>
</ul>
<h2 id="Bayesian-Statistics">Bayesian Statistics</h2>
<ul>
<li><a href="/studynotes/bayesian-statistics/01_Probability">01. Probability</a></li>
<li><a href="/studynotes/bayesian-statistics/02_Distribution">02. Distribution</a></li>
<li><a href="/studynotes/bayesian-statistics/03-Frequentist-Inference">03. Frequentist Inference</a></li>
<li><a href="/studynotes/bayesian-statistics/04-Bayesian-Inference">04. Bayesian Inference</a></li>
<li><a href="/studynotes/bayesian-statistics/05-Credible-Intervals">05. Credible Intervals</a></li>
<li><a href="/studynotes/bayesian-statistics/06_Prior_Posterior_predictive">06. Prior &amp; Posterior Predictive</a></li>
<li><a href="/studynotes/bayesian-statistics/07_Priors">07. Priors</a></li>
<li><a href="/studynotes/bayesian-statistics/08_Bayesian_Modeling">08. Bayesian Modeling</a></li>
<li><a href="/studynotes/bayesian-statistics/09_Monte_Carlo_Estimation">09. Monte Carlo Estimation</a></li>
<li><a href="/studynotes/bayesian-statistics/10_Markov_chain_Monte_Carlo">10. Markov Chain Monte Carlo</a></li>
<li><a href="/studynotes/bayesian-statistics/11_Linear_Regression">11. Linear Regression</a></li>
<li><a href="/studynotes/bayesian-statistics/12_Prior_Sensitivity_Analysis">12. Prior Sensitivity Analysis</a></li>
<li><a href="/studynotes/bayesian-statistics/13_Hierarchical_models">13. Hierarchical Models</a></li>
<li><a href="/studynotes/bayesian-statistics/14_Predictive_Simulation">14. Predictive Simulation</a></li>
<li><a href="/studynotes/bayesian-statistics/APPENDIX-1-MAP">Appendix 01. Maximize a Posterior (MAP)</a></li>
<li><a href="/studynotes/bayesian-statistics/APPENDIX-2-Empirical-Bayes">Appendix 02. Empirical Bayes (MAP)</a></li>
</ul>
<h2 id="Reinforcement-Learning">Reinforcement Learning</h2>
<ul>
<li><a href="/studynotes/reinforcement-learning/01_Introduction">01. Introduction</a></li>
<li><a href="/studynotes/reinforcement-learning/02-K-arm-Bandits-Problems">02. K-arm Bandits Problems</a></li>
<li><a href="/studynotes/reinforcement-learning/03-Markov-Decision-Process">03. Markov Decision Process</a></li>
<li><a href="/studynotes/reinforcement-learning/04-Policies-and-Value-Functions">04. Policies and Value Functions</a></li>
<li><a href="/studynotes/reinforcement-learning/05-Policy-Evaluation-vs-Control">05. Policy Evaluation &amp; Control</a></li>
<li><a href="/studynotes/reinforcement-learning/06-Sample-based-Reinforcement-Learning">06. Sample-based Reinforcement Learning</a></li>
<li><a href="/studynotes/reinforcement-learning/07-Off-Policy-Learning">07. Off-Policy Learning</a></li>
<li><a href="/studynotes/reinforcement-learning/08-Temporal-Difference-Learning">08. Temporal Difference Learning</a></li>
<li><a href="/studynotes/reinforcement-learning/09-Models-and-Planning">09. Models and Planning</a></li>
<li><a href="/studynotes/reinforcement-learning/10-Prediction-and-Control-with-Function-Approximation">10. Prediction and Control with Function Approximation</a></li>
<li><a href="/studynotes/reinforcement-learning/11-Feature-Construction">11. Feature Construction</a></li>
</ul>

</div>

<script src="/js/book-menu.js"></script>
  </div>

  <div class="sidebar-toggle" onclick="sidebar_toggle()" onmouseover="add_inner()" onmouseleave="remove_inner()">
  <div class="sidebar-toggle-inner"></div>
</div>

<script>
function add_inner() {
  let inner = document.querySelector('.sidebar-toggle-inner')
  inner.classList.add('show')  
}

function remove_inner() {
  let inner = document.querySelector('.sidebar-toggle-inner')
  inner.classList.remove('show')
}

function sidebar_toggle() {
    let sidebar_toggle = document.querySelector('.sidebar-toggle')
    let sidebar = document.querySelector('.book-sidebar')
    let content = document.querySelector('.off-canvas-content')
    if (sidebar_toggle.classList.contains('extend')) { // show
        sidebar_toggle.classList.remove('extend')
        sidebar.classList.remove('hide')
        content.classList.remove('extend')
    }
    else { // hide
        sidebar_toggle.classList.add('extend')
        sidebar.classList.add('hide')
        content.classList.add('extend')
    }
}
</script>

  <div class="off-canvas-content">
    <div class="columns">
      <div class="column col-10 col-lg-12">
        <div class="book-navbar">
          <!-- For Responsive Layout -->

<header class="navbar">
  <section class="navbar-section">
    <a onclick="open_sidebar()">
      <i class="icon icon-menu"></i>
    </a>
  </section>
</header>

        </div>
        <div class="book-content">
          <div class="book-post">
  <h1>Restrict Boltzmann Machines</h1>
<p>이번에는 RBM의 학습, 즉, weight를 수정하는 방법을 알아보고자 한다. RBM의 학습 역시 MLE 방식을 이용하게 된다. 즉, 데이터에 대한 likelihood를 최대화하게 된다.<br>
$$<br>
\hat{W}, \hat{b}, \hat{c} = \underset{W,b,c}{ \text{argmax} } ~ p(v)<br>
$$<br>
데이터는 visible unit에 들어가게 되므로, $$p(v)$$를 최대화하게 된다.</p>
<p>그런데 왜 $$p(v)$$를 최대화하는게 RBM의 학습일까. 그 이유는, 현재 데이터가 얻어진 이유는 상대적으로 높은 확률을 가지기 때문에 얻어진 것일 것이고, 왠만하면 불안정 상태보다 안정 상태의 데이터일 가능성이 높다.</p>
<p>그런데, $$p(v)$$는 intractable하다.<br>
$$<br>
p(v) = \sum_h p(v,h) = \sum_h \frac{1}{Z} \text{exp} { \sum_i \sum_j W_{i,j} v_i h_j + \sum_i b_i v_i + \sum_j c_j h_j }<br>
$$<br>
여기서, normalizaiton constant는 모델 크기가 매우 작지 않는 이상 intractable하다.</p>
<h2 id="Free-Energy">Free Energy</h2>
<p>일단 미분을 위해 다음을 정의한다.<br>
$$<br>
F(v) = -\text{log} \sum_h e^{-E(v,h)}<br>
$$<br>
$F(v)$를 Free energy라고 정의한다. 특별한 의미가 있는것은 아니라고 한다. 편의상 정의하는 것 같다.</p>
<p>Free energy식을 조금만 변형한다.<br>
$$<br>
e^{-F(v)} = \sum_h e^{-E(v, h)}<br>
$$<br>
Free energy를 이용해서 $p(v)$를 $F(v)$에 대한 식으로 정리해보면,<br>
$$<br>
p(v) = \sum_h p(v,h) = \sum_h \frac{1}{Z} e^{-E(v,h)} \<br>
p(v) = \frac{1}{Z} e^{-F(v)}<br>
$$<br>
따라서, normalization constant는 다음과 같다고도 할 수 있다.<br>
$$<br>
Z = \sum_{v’} e^{-F(v’)}<br>
$$<br>
이제, $\text{log} ~ p(v)$를 미분해보면,<br>
$$<br>
\frac{d \text{log} ~p(v)}{d\theta} = \frac{d}{d\theta}[\text{log} \frac{1}{Z}e^{-F(v)}]<br>
$$<br>
$$<br>
= \frac{d}{d\theta} [\text{log} ~e^{-F(v)} - \text{log}~Z]<br>
$$</p>
<p>$$<br>
= \frac{d}{d\theta}[-F(v)] - \frac{d}{d\theta}[\text{log} Z]<br>
$$</p>
<p>$$<br>
= -\frac{dF(v)}{d\theta} - \frac{1}{Z} \frac{dZ}{d\theta}<br>
$$</p>
<p>$$<br>
= -\frac{dF(v)}{d\theta} - \frac{1}{Z} \frac{d}{d\theta}[\sum_{v’} e^{-F(v’)}]<br>
$$</p>
<p>$$<br>
= -\frac{dF(v)}{d\theta} + \sum_{v’} \frac{1}{Z} e^{-F(v’)} \frac{dF(v’)}{d\theta}<br>
$$</p>
<p>$$<br>
= -\frac{dF(v)}{d\theta} + \sum_{v’} p(v’) \frac{dF(v’)}{d\theta}<br>
$$</p>
<p>이때, 양변에 - 부호를 곱해주면서,<br>
$$<br>
-\frac{d \text{log} ~p(v)}{d\theta} = \frac{dF(v)}{d\theta} - \sum_{v’}p(v’)\frac{dF(v’)}{d\theta}<br>
$$<br>
그런데, 이때, 두번째 항은 $E[\frac{dF(v’)}{d\theta}]$와 같다.<br>
$$<br>
-\frac{d\text{log} ~ p(v)}{d\theta} = \frac{dF(v)}{d\theta} - E[\frac{dF(v’)}{d\theta}]<br>
$$<br>
이제 이것을 적분해보면, negative log likelihood를 얻을 수 있다. 이는 곧 cost와 같다.<br>
$$<br>
\mathbb{L} = F(v) - E[F(v’)]<br>
$$<br>
이 loss는 두 개의 term으로 나뉘는데, 첫번째는 positive term이고, 두번째는 negative term인데, 다음과 같은 역할을 한다.</p>
<ul>
<li>
<p>Positive term</p>
<p>Visible unit에 입력으로 들어간 데이터에 대한 에너지는 낮게 유도하는 효과가 있다.</p>
</li>
<li>
<p>Negative term</p>
<p>Visible unit에 입력으로 들어간 데이터 이외에 모든 조합들에 대해 에너지를 높게 유도한다.</p>
</li>
</ul>
<p>사실상 대부분 EBM은 위와 같은 cost를 가진다고 한다. (또는 가저야만 한다고 한다)</p>
<h2 id="Contrastive-Divergence">Contrastive Divergence</h2>
<p>EBM에서, positive data와 negative data를 가지고, positive data의 에너지는 상대적으로 낮게, negative data의 에너지는 상대적으로 높게 학습시키는 방법을 말한다.</p>
<p>위 cost function을 보면, negative term은 intractable하다.  가능한 모든 visible unit 조합이 필요하기 때문. 따라서 기댓값을 추정해야 하는데, 기댓값은 Monte Carlo estimation처럼 샘플들의 평균으로 추정할 수 있다. 즉, negative term은 다음처럼 표현이 가능하다.<br>
$$<br>
E[F(v’)] = \frac{1}{n} \sum_{i=1}^n F(v’_i)<br>
$$<br>
Visible unit을 샘플링해야 위 수식처럼 negative term을 추정할 수 있는데, visible unit을 샘플링해야 한다는 이야기가 된다. 이것은 RBM으로 샘플링이 가능하다.</p>
<h3 id="Gibbs-Sampling">Gibbs Sampling</h3>
<p>Gibbs sampling이라고 하면, Markov chain Monte Carlo의 일종이다. Markov chain Monte Carlo 방법은 어떤 random variable에 대해 모델링한 후, Markov chain을 통해 샘플을 생성하는데, 모델이 여러 random variable을 포함하는 경우, Gibbs sampling을 이용한다. Gibbs sampling은 하나의 random variable 이외에 다른 random variable이 모두 주어졌다(given)고 가정하고 샘플링하는 방식이다.</p>
<p>RBM은 다음과 같은 과정으로 샘플을 생성한다.</p>
<ol>
<li>주어진 데이터로 $p(h=1|v)$를 계산한다.</li>
<li>$p(h=1|v)$를 이용해서 $h$를 샘플링한다.</li>
<li>샘플링한 $h$를 이용해서 $p(v’=1|h)$를 계산한다.</li>
<li>$v’$을 샘플링한다.</li>
</ol>
<p>이렇게 하면, visible unit하나를 새로 샘플링한 것이다.</p>
<p>RBM의 구조는 Markov chain의 구조이며(visible unit은 바로 앞의 hidden unit들에게 의해서만 영향을 받음), 위 처럼 샘플링하는 것은 MCMC의 일종이다. 특히, Gibbs sampling의 일종이라고 하는데, 왜 Gibbs sampling인지는 잘 모르겠다. 여러 블로그들은 그저 “이것은 Gibbs sampling이다” 라고만 소개되어 있고, 이유를 소개한 블로그는 찾기 힘들다.</p>
<h3 id="CD-k-Contrastive-Divergence-with-k-Samples">CD-k (Contrastive Divergence with k Samples)</h3>
<p>그럼 visible unit을 어떻게 샘플링해야 하는지는 결정되었고(RBM을 통한 MCMC 샘플링), 과연 몇 개의 샘플이 필요한가가 논의될 필요가 있다. MCMC를 통한 기댓값 추정은 MCMC의 이름에서 알수 있다시피, Monte Carlo 추정법을 이용하게 된다. 그리고, Monte Carlo 추정은 샘플이 많을수록 좋고 정확하다.</p>
<p>하지만, RBM에서는 단 하나의 샘플로만 해도 괜찮다고 한다. 즉, CD-1 방식을 이용한다. RBM의 학습은, 데이터셋에서 관찰되는 visible unit조합들에 대해서의 에너지는 높게, 그 이외의 조합들에 대해서는 에너지가 낮게 하는게 목적이다. CD-1 방식은 CD-k 중에서는 그 효과가 가장 떨어진다고 할지라도, 크게 문제가 되지 않는다고 한다.</p>
<h3 id="Fake-Loss">Fake Loss</h3>
<p>RBM의 loss는 직접 계산할 수 없다. Negative term이 intractable하기 때문이다. 따라서, 이를 Monte Carlo 추정법으로 추정했다(1개의 샘플로). 즉, 다음처럼 loss가 수정될 수 있다.<br>
$$<br>
\text{fake-loss} = F(v) - F(v’)<br>
$$<br>
<strong>Fake loss는 공식적으로 붙은 이름은 아니다.</strong></p>
<p>진짜 loss는 아니지만, loss를 추정한 것이라서 이렇게 부르기로 한다.</p>
<p>진짜 loss는 다음 식이다.<br>
$$<br>
\text{loss} = F(v) - \mathbb{E}_{v’}[F(v’)]<br>
$$</p>
<h3 id="Intractability-of-Free-Energy">Intractability of Free Energy</h3>
<p>그런데, free energy의 식을 보면 가능한 모든 hidden unit 조합에 대한 summation이 있다.<br>
$$<br>
F(v) = -\text{log} \sum_h e^{-E(v,h)}<br>
$$<br>
Hidden unit 조합을 모두 구한다는 것도 사실상 intractable하다. Free energy를 tractable하게 변환할 수 있다면, loss 함수를 계산할 수 있을 것이다.</p>
<p>Free energy 식에서, $E(v,h)$를 원래 에너지 식으로 대체한다.<br>
$$<br>
F(v) = - \text{log} \sum_h \text{exp}(\sum_i \sum_j W_{i,j}v_ih_j + \sum_i b_iv_i + \sum_j c_j h_j)<br>
$$<br>
그리고 다음처럼 $$h$$와 관계없는 항은 제일 밖으로 뺄 수 있다.<br>
$$<br>
F(v) = -\text{log} ~\text{exp}(\sum_i b_i v_i) \sum_h \text{exp}(\sum_i \sum_j W_{i,j}v_i h_j + \sum_j c_jh_j)<br>
$$<br>
$$<br>
= -\sum_i b_iv_i - \text{log} \sum_h \text{exp} (\sum_i \sum_j W_{i,j} v_i h_j + \sum_j c_j h_j)<br>
$$</p>
<p>$\text{exp}$안에 $\sum_j$가 공통으로 포함되어 있으므로 밖으로 뺀다.<br>
$$<br>
F(v) = -\sum_i b_i v_i - \text{log} \sum_h \prod_j \text{exp} (\sum_i W_{i,j} v_i h_j + c_j h_j)<br>
$$<br>
$h_j$도 빼보자.<br>
$$<br>
F(v) = - \sum_i b_i v_i - \text{log} \sum_h \prod_j \text{exp} {h_j(\sum_iW_{i,j} v_i + c_j)}<br>
$$<br>
그리고, $u_{j} = \sum_i W_{i,j} v_i + c_j$라고 해 보자(어차피 $i$방향으로는 summation이므로 변수가 아니다. 따라서 $j$로만 인덱싱한다).<br>
$$<br>
F(v) = -\sum_i b_i v_i - \text{log}\sum_h \prod_j \text{exp} {h_j u_j}<br>
$$<br>
$h_j$는 베르누이 변수이므로, ${0, 1}$중 하나의 값을 가진다. $\text{log}$안의 term은 가능한 모든 $h$의 조합을 더한 것을 의미하게 된다. 즉, hidden unit 수가 $M$개라면, $2^M$개의 경우를 모두 더하는 것이다.</p>
<p>근데, 만약, hidden unit 개수가 2개라고 해 보자(즉 $j=[0,1]$). 그럼 $\text{log}$안은 다음처럼 된다.<br>
$$<br>
e^{0u_0}e^{0u_1} + e^{0u_0}e^{1u_1} + e^{1u_0}e^{0u_1} + e^{1u_0}e^{1u_1}<br>
$$<br>
$$<br>
= (e^{0u_0} + e^{1u_0})(e^{0u_1} + e^{1u_1})<br>
$$</p>
<p>$j$번째 hidden unit $h_j$는 0과 1밖에 가지지 못하기에 위 4가지 경우가 전부.</p>
<p>그렇다면, hidden unit 개수가 $M=3$이라고 해 보자. 정리해보면 다음처럼 나올 것이다.<br>
$$<br>
(e^{0u_0} + e^{1u_0})(e^{0u_1} + e^{1u_1})(e^{0u_2} + e^{1u_2})<br>
$$<br>
즉,<br>
$$<br>
\sum_h \prod_j \text{exp} { h_j u_j } = \prod_{j} \sum_{h_j={0,1}} \text{exp} {h_j u_j}<br>
$$<br>
이며, 이것의 time complexity는 $M$이다. (인수분해를 활용한 계산 최적화!)</p>
<p>즉, free energy는 다음처럼 정리가 가능하다.<br>
$$<br>
F(v) = -\sum_i b_i v_i - \text{log} \prod_j \sum_{h_j={0,1}} \text{exp}{ h_j(\sum_i W_{i,j} v_i + c_j) }<br>
$$<br>
$$<br>
= -\sum_i b_i v_i - \sum_j \text{log} (1+ \text{exp} {\sum_i W_{i,j} v_i + c_j})<br>
$$</p>
<p>이는, tractable하다.</p>

</div>


  <div class="book-comments">
    




  </div>


<script src="/js/book-post.js"></script>
        </div>
      </div>
      <div class="column col-2 hide-lg">
        <div class="book-post-info">
  
    <div class="book-post-meta">

  <div class="author">

    <!-- Author image -->
    <div class="author-img">
      
        <figure class="avatar avatar-lg">
          <img src="/log.png" alt="...">
        </figure>
      
    </div>

    <!-- Author title -->
    <div class="author-title">
      <div>Lee Jaeyoung</div>
      <div>2020-03-03</div>
    </div>
  </div>

  
    <div class="divider"></div>

    <div class="link">
      <a class="category-link" href="/categories/Study-Notes/">Study Notes</a> <a class="category-link" href="/categories/Study-Notes/Machine-Learning/">Machine Learning</a>

      <a class="tag-link" href="/tags/MachineLearning/">#MachineLearning</a> <a class="tag-link" href="/tags/StudyNotes/">#StudyNotes</a>
    </div>
    
  

  <div class="divider"></div>
</div>
  

  <div class="book-tocbot">
</div>
<div class="book-tocbot-menu">
  <a class="book-toc-expand" onclick="expand_toc()">Expand all</a>
  <a onclick="go_top()">Back to top</a>
  <a onclick="go_bottom()">Go to bottom</a>
</div>

<script src="/js/book-toc.js"></script>
</div>
      </div>
    </div>
  </div>
  
  <a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>

</body>
</html>

<script src="/js/book.js"></script>